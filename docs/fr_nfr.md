## Функциональные требования

### Оффер
- Создать оффер по станции и пользователю
- Проверять свежесть оффера
- Отклонять создание заказа по просроченному офферу

### Заказ
- Идемпотентный старт аренды (по Idempotency-Key)
- В момент старта:
  - зарезервировать/выдать банку на станции (stations).
  - зафиксировать выбранный тариф (snapshot тарифа).
  - создать платёжную сессию (payments) - по стране/валюте.
- Поддержать мультивалютность (валюта тарифа -> валюта заказа)

### Возврат
- Рассчитать итоговую стоимость, списать оплату
- Вернуть банку на станцию
- завершить заказ

### Инфо по аренде
- `get_rent_info`: статусы, страна/валюта, текущая накопленная стоимость.

### Источники
- Критичные: `stations`, `payments` — при недоступности операция не выполняется.
- Некритичные: config (минутный кэш), tariffs (LRU-кэш, давность >10 минут -> ошибка), users (фоллбэк на «жадный прайсинг», максимальный тариф).

## Нефункциональные требования

### Надёжность / согласованность
- Идемпотентность: - Все мутации принимают заголовок Idempotency-Key (uuid). Повтор с теми же параметрами -> `200/201`, иначе `409`.
- Транзакционная запись заказа + outbox для интеграционных событий/компенсаций.
- Предсказуемая деградация:
  - tariffs недоступен - кэш ≤10 минут, иначе 5xx с меткой tariffs_stale.
  - users недоступен - «жадный» тариф/лимиты, пометка в событии.
  - config недоступен - использовать минутный кэш.


### get_rent_info (формат)
```json
{
  "rental_id": "…",
  "status": "active",
  "user_id": "…",
  "country": "DE",
  "currency": "EUR",
  "started_at": "…",
  "ended_at": null,
  "current_amount": "100"
}
```


### Хранение
- Z≈1 КБ на запись; за год — партиции по месяцу/стране; авто-чистка.

# Наблюдаемость

- Структурные логи (JSON), корреляция по request_id, idempotency_key.

# Развёртывание
- Docker + docker-compose (локально).
- БД миграции — Alembic.
